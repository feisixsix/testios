workflows:
  ios-workflow:
    name: iOS Workflow
    instance_type: mac_mini_m2
    max_build_duration: 120
    environment:
      flutter: stable
    triggering:
      events:
        - push
        - pull_request
    cache:
      cache_paths:
        - $HOME/.pub-cache
        - $HOME/Library/Caches/flutter
        - $HOME/Library/Developer/Xcode/DerivedData
    scripts:
      - name: Get Flutter packages
        script: |
          flutter pub get
      - name: Prepare iOS build
        script: |
          # 预缓存 iOS Flutter 引擎
          flutter precache ios

          # 确保 ephemeral 目录存在
          mkdir -p ios/Flutter/ephemeral

          # 生成 xcconfig 文件
          FLUTTER_ROOT=$(dirname $(dirname $(which flutter)))
          cat > ios/Flutter/Generated.xcconfig << EOF
// This is a generated file; do not edit or check into version control.
FLUTTER_ROOT=$FLUTTER_ROOT
FLUTTER_APPLICATION_PATH=\$SRCROOT/..
COCOAPODS_PARALLEL_CODE_SIGN=true
FLUTTER_TARGET=\$SRCROOT/../lib/main.dart
FLUTTER_BUILD_DIR=build
FLUTTER_BUILD_NAME=1.0.0
FLUTTER_BUILD_NUMBER=1.0.0
EXCLUDED_ARCHS[sdk=iphonesimulator*]=i386
EXCLUDED_ARCHS[sdk=iphoneos*]=armv7
DART_OBFUSCATION=false
TRACK_WIDGET_CREATION=true
TREE_SHAKE_ICONS=false
PACKAGE_CONFIG=\$SRCROOT/../.dart_tool/package_config.json
EOF

          # 复制到 ephemeral
          cp ios/Flutter/Generated.xcconfig ios/Flutter/ephemeral/

          # 创建 export environment script
          cat > ios/Flutter/ephemeral/flutter_export_environment.sh << 'EOF'
#!/bin/bash
# Generated by Flutter

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
FLUTTER_ROOT="${FLUTTER_ROOT:-$(dirname $(dirname $(which flutter)))}"
PROJECT_DIR="$(dirname $(dirname "$SCRIPT_DIR"))"
export FLUTTER_ROOT
export FLUTTER_APPLICATION_PATH="$PROJECT_DIR"
export PACKAGE_CONFIG="${PROJECT_DIR}/.dart_tool/package_config.json"
EOF

          chmod +x ios/Flutter/ephemeral/flutter_export_environment.sh

          # 验证文件
          echo "=== ios/Flutter/ contents ==="
          ls -la ios/Flutter/
          echo ""
          echo "=== ios/Flutter/ephemeral/ contents ==="
          ls -la ios/Flutter/ephemeral/
      - name: Build iOS app (unsigned for AltStore)
        script: |
          # 构建 iOS Release 版本
          flutter build ipa --release --no-codesign

          # 查找构建产物
          echo "=== Build artifacts ==="
          find . -name "*.ipa" -type f
          ls -la build/ios/iphoneos/ 2>/dev/null || echo "ipa directory not found"
    artifacts:
      - build/ios/iphoneos/*.ipa
